@page "{id:int}"
@model SistemaContableLaDat.Pages.Asientos.EditarModel
@{
    ViewData["Title"] = "Edición de Asiento";
    Layout = "_PrincipalLayout";
}

<div class="container-fluid">
    <div class="card shadow">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Administración de Asiento #@Model.Encabezado.Consecutivo</h5>
            <span id="badgeEstado" class="badge bg-info">Analizando...</span>
        </div>
        <div class="card-body">
            <form id="formAsiento" method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <input type="hidden" asp-for="Encabezado.IdAsiento" />
                <input type="hidden" asp-for="Encabezado.IdPeriodo" />
                <input type="hidden" asp-for="Encabezado.Consecutivo" />
                <input type="hidden" asp-for="DetallesJson" id="inputDetallesJson" />

                <div class="row g-3 mb-4">
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Código</label>
                        <input asp-for="Encabezado.Codigo" class="form-control" readonly />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Fecha</label>
                        <input asp-for="Encabezado.Fecha" type="date" class="form-control" required />
                    </div>
                    <div class="col-md-7">
                        <label class="form-label fw-bold">Referencia (Descripción)</label>
                        <input asp-for="Encabezado.Referencia" class="form-control" placeholder="Ej: Pago de servicios públicos" required />
                    </div>
                </div>

                <hr />

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Detalle de Movimientos</h5>
                    <button type="button" class="btn btn-dark btn-sm" onclick="agregarFila()">
                        <i class="bi bi-plus-circle"></i> Agregar Línea
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="tablaDetalles">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40%;">Cuenta Contable</th>
                                <th style="width: 15%;">Tipo</th>
                                <th style="width: 15%;">Monto</th>
                                <th>Descripción</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="tbodyDetalles">
                        </tbody>
                        <tfoot>
                            <tr class="table-secondary fw-bold">
                                <td colspan="2" class="text-end">TOTALES:</td>
                                <td>
                                    <div class="d-flex justify-content-between px-2">
                                        <span>D: <span id="totalDebe">0.00</span></span>
                                        <span>H: <span id="totalHaber">0.00</span></span>
                                    </div>
                                </td>
                                <td colspan="2" id="msgBalance" class="text-center"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="mt-4 border-top pt-3 text-end">
                    <a asp-page="./Index" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" id="btnGuardar" class="btn btn-dark px-4">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const cuentasDisponibles = @Html.Raw(Json.Serialize(Model.Cuentas));
        const detallesCargados = @Html.Raw(Model.DetallesJson);

        document.addEventListener('DOMContentLoaded', () => {
            if (detallesCargados && detallesCargados.length > 0) {
                detallesCargados.forEach(d => agregarFila(d));
            } else {
                agregarFila(); 
            }
        });

        function agregarFila(datos = null) {
            const tbody = document.getElementById('tbodyDetalles');
            const tr = document.createElement('tr');
            tr.className = "fila-detalle";

            let opcionesCuentas = '<option value="">-- Seleccione Cuenta --</option>';
            cuentasDisponibles.forEach(c => {
                const selected = (datos && (datos.idCuentaContable || datos.IdCuentaContable) == c.idCuenta) ? 'selected' : '';
                opcionesCuentas += `<option value="${c.idCuenta}" ${selected}>${c.codigoCuenta} - ${c.nombre}</option>`;
            });

            tr.innerHTML = `
                <td>
                    <select class="form-select form-select-sm select-cuenta" required>
                        ${opcionesCuentas}
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm select-tipo" onchange="recalcular()">
                        <option value="D" ${(datos && datos.tipoMovimiento == 'D') ? 'selected' : ''}>Débito</option>
                        <option value="C" ${(datos && datos.tipoMovimiento == 'C') ? 'selected' : ''}>Crédito</option>
                    </select>
                </td>
                <td>
                    <input type="number" step="0.01" class="form-control form-control-sm text-end input-monto"
                           value="${datos ? datos.monto : '0.00'}" oninput="recalcular()" required />
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm input-desc"
                           value="${datos ? (datos.descripcion || '') : ''}" />
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="eliminarFila(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
            recalcular();
        }

        function eliminarFila(boton) {
            const filas = document.querySelectorAll('#tbodyDetalles tr');
            if (filas.length > 1) {
                boton.closest('tr').remove();
                recalcular();
            } else {
                alert("El asiento debe tener al menos una línea.");
            }
        }

        function recalcular() {
            let debe = 0;
            let haber = 0;

            document.querySelectorAll('#tbodyDetalles tr').forEach(fila => {
                const tipo = fila.querySelector('.select-tipo').value;
                const monto = parseFloat(fila.querySelector('.input-monto').value) || 0;
                if (tipo === 'D') debe += monto;
                else haber += monto;
            });

            document.getElementById('totalDebe').innerText = debe.toFixed(2);
            document.getElementById('totalHaber').innerText = haber.toFixed(2);

            const diff = Math.abs(debe - haber);
            const msgBalance = document.getElementById('msgBalance');
            const badge = document.getElementById('badgeEstado');

            if (diff < 0.01 && (debe + haber) > 0) {
                msgBalance.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill"></i> Balanceado</span>';
                badge.className = "badge bg-success";
                badge.innerText = "Listo para Aprobar";
            } else {
                msgBalance.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Desbalanceado (${diff.toFixed(2)})</span>`;
                badge.className = "badge bg-warning text-dark";
                badge.innerText = "Borrador (Incompleto)";
            }
        }

        document.getElementById('formAsiento').addEventListener('submit', function (e) {
            const detalles = [];
            let error = false;

            document.querySelectorAll('#tbodyDetalles tr').forEach(fila => {
                const idCuenta = fila.querySelector('.select-cuenta').value;
                const monto = parseFloat(fila.querySelector('.input-monto').value) || 0;

                if (!idCuenta) error = true;

                detalles.push({
                    IdCuentaContable: parseInt(idCuenta),
                    TipoMovimiento: fila.querySelector('.select-tipo').value,
                    Monto: monto,
                    Descripcion: fila.querySelector('.input-desc').value
                });
            });

            if (error) {
                alert("Por favor, seleccione una cuenta contable para todas las líneas.");
                e.preventDefault();
                return;
            }

            document.getElementById('inputDetallesJson').value = JSON.stringify(detalles);
        });
    </script>
}