@page
@model SistemaContableLaDat.Web.Pages.Asientos.IndexModel
@using SistemaContableLaDat.Entities.Asientos

@{
    ViewData["Title"] = "Administración de Asientos";
    Layout = "_PrincipalLayout";
}

<h1 class="mt-4">Administración de Asientos Contables</h1>
<p>
    <a class="btn btn-dark" asp-page="Crear">
        <i class="bi bi-plus-circle"></i> Nuevo
    </a>
</p>


<table class="table table-hover align-middle">
    <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>Fecha</th>
            <th>Código</th>
            <th>Referencia</th>
            <th>Estado</th>
            <th>Balance</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var a in Model.Asientos)
        {
            var estadoClass = a.IdEstadoAsiento switch
            {
                (int)EstadoAsiento.Borrador => "table-warning",
                (int)EstadoAsiento.PendienteAprobar => "table-info",
                (int)EstadoAsiento.Aprobado => "table-success",
                _ => ""
            };

            <tr class="@estadoClass">
                <td>@a.Consecutivo</td>
                <td>@a.Fecha.ToString("dd/MM/yyyy")</td>
                <td>@a.Codigo</td>
                <td>@a.Referencia</td>
                <td>
                    <span class="badge bg-secondary">@a.EstadoNombre</span>
                </td>
                <td>
                    @if (a.EstaBalanceado)
                    {
                        <span class="badge bg-success">Balanceado</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">No balanceado</span>
                    }
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="collapse"
                            data-bs-target="#det-@a.IdAsiento"
                            onclick="cargarDetalle(@a.IdAsiento)">
                        Detalle
                    </button>

                    @if (a.PuedeEditar)
                    {
                        <a asp-page="Editar"
                           asp-route-id="@a.IdAsiento"
                           class="btn btn-sm btn-outline-secondary">
                            Editar
                        </a>

                        <a asp-page="Anular"
                           asp-route-id="@a.IdAsiento"
                           class="btn btn-sm btn-outline-danger">
                            Anular
                        </a>
                    }
                </td>
            </tr>

            <tr class="collapse bg-light" id="det-@a.IdAsiento">
                <td colspan="7">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th style="width: 25%">Cuenta</th>
                                <th style="width: 10%" class="text-center">Tipo</th>
                                <th style="width: 20%" class="text-end pe-4">Monto</th>
                                <th style="width: 45%">Descripción</th>
                            </tr>
                        </thead>
                        <tbody id="detalle-@a.IdAsiento">
                        </tbody>
                        <tfoot id="footer-@a.IdAsiento" class="table-secondary d-none">
                            <tr class="fw-bold">
                                <td colspan="2" class="text-end">TOTALES:</td>
                                <td class="text-end pe-4" id="sumas-@a.IdAsiento"></td>
                                <td id="balance-@a.IdAsiento" class="text-start"></td>
                            </tr>
                        </tfoot>
                    </table>
                </td>
            </tr>
        }
    </tbody>
</table>

<script>
    function cargarDetalle(id) {
        const contenedor = document.getElementById(`detalle-${id}`);
        const footer = document.getElementById(`footer-${id}`);
        const sumas = document.getElementById(`sumas-${id}`);
        const balance = document.getElementById(`balance-${id}`);

        fetch(`?handler=Detalle&idAsiento=${id}`)
            .then(r => r.json())
            .then(data => {
                let html = "";
                let totalDebito = 0;
                let totalCredito = 0;

                data.forEach(d => {
                    const tipo = d.tipoMovimiento.trim().toUpperCase();

                    if (tipo.startsWith("D")) {
                        totalDebito += d.monto;
                    } else if (tipo.startsWith("C")) {
                        totalCredito += d.monto;
                    }

                    html += `<tr>
                        <td style="width: 25%">${d.cuenta}</td>
                        <td style="width: 10%" class="text-center">${tipo}</td>
                        <td style="width: 20%" class="text-end pe-4 font-monospace">
                            ${d.monto.toLocaleString('es-CR', { minimumFractionDigits: 2 })}
                        </td>
                        <td style="width: 45%">${d.descripcion || ''}</td>
                    </tr>`;
                });

                contenedor.innerHTML = html;

                if (footer) {
                    footer.classList.remove('d-none');

                    sumas.innerHTML = `
                        <div class="text-end pe-4">
                            <small>D:</small> ${totalDebito.toLocaleString('es-CR', { minimumFractionDigits: 2 })}<br>
                            <small>C:</small> ${totalCredito.toLocaleString('es-CR', { minimumFractionDigits: 2 })}
                        </div>
                    `;

                    const diferencia = Math.abs(totalDebito - totalCredito);
                    if (diferencia < 0.01 && totalDebito > 0) {
                        balance.innerHTML = '<span class="badge bg-success w-100"><i class="bi bi-check-circle"></i> Balanceado</span>';
                    } else {
                        balance.innerHTML = `
                            <span class="badge bg-danger w-100"><i class="bi bi-exclamation-triangle"></i> Desbalanceado</span>
                            <small class="d-block text-center text-danger fw-bold mt-1">Dif: ${diferencia.toLocaleString('es-CR', { minimumFractionDigits: 2 })}</small>
                        `;
                    }
                }
            })
            .catch(err => {
                console.error("Error al cargar detalle:", err);
                contenedor.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar los datos.</td></tr>';
            });
    }
</script>
